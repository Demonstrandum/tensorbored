name: Deploy Demo to HuggingFace Spaces

on:
  workflow_run:
    workflows: ['Wheel Prerelease']
    types:
      - completed
    branches:
      - master
  workflow_dispatch:

permissions:
  actions: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download wheel artifact (workflow_run)
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: tensorbored-rc-wheel
          path: wheel
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download wheel artifact (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: wheel-prerelease.yml
          name: tensorbored-rc-wheel
          path: wheel
          branch: master

      - name: Get wheel info
        id: wheel
        run: |
          WHEEL_FILE=$(ls wheel/*.whl | head -1)
          WHEEL_NAME=$(basename "$WHEEL_FILE")
          echo "filename=${WHEEL_NAME}" >> $GITHUB_OUTPUT
          echo "Using wheel: ${WHEEL_NAME}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install huggingface_hub
        run: pip install huggingface_hub

      - name: Prepare Space files
        run: |
          mkdir -p hf-space
          cp wheel/*.whl hf-space/
          cp demo/Dockerfile hf-space/
          cp demo/README.md hf-space/
          cp demo/generate_demo_data.py hf-space/
          cp demo/start.sh hf-space/

          # Create cache-busting file to force Docker layer invalidation.
          # Without this, HuggingFace Spaces may use cached pip install with old wheel.
          WHEEL_NAME="${{ steps.wheel.outputs.filename }}"
          SHORT_SHA="${GITHUB_SHA:0:7}"
          echo "wheel=${WHEEL_NAME}" > hf-space/.build-version
          echo "commit=${SHORT_SHA}" >> hf-space/.build-version
          echo "timestamp=$(date -u +%Y%m%d%H%M%S)" >> hf-space/.build-version
          cat hf-space/.build-version

      - name: Upload to HuggingFace Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          WHEEL_NAME="${{ steps.wheel.outputs.filename }}"
          SHORT_SHA="${GITHUB_SHA:0:7}"

          python3 << EOF
          from huggingface_hub import HfApi

          api = HfApi()
          repo_id = "Demonstrandum/tensorbored-sample"

          print(f"Uploading to {repo_id}")
          print(f"Wheel: ${WHEEL_NAME}")

          api.upload_folder(
              folder_path="hf-space",
              repo_id=repo_id,
              repo_type="space",
              commit_message="Deploy ${WHEEL_NAME} (${SHORT_SHA})",
          )
          print("Deployed successfully!")
          EOF

      - name: Wait for HuggingFace Space build
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python3 << 'EOF'
          import os
          import sys
          import time
          from huggingface_hub import HfApi

          api = HfApi()
          repo_id = "Demonstrandum/tensorbored-sample"

          print(f"Waiting for Space build to complete: {repo_id}")
          print("=" * 60)

          # Poll for build status with timeout
          max_wait_seconds = 600  # 10 minutes
          poll_interval = 15  # seconds
          elapsed = 0

          while elapsed < max_wait_seconds:
              try:
                  space_info = api.space_info(repo_id=repo_id)
                  runtime = space_info.runtime

                  if runtime is None:
                      print(f"[{elapsed}s] Space runtime info not available yet...")
                      time.sleep(poll_interval)
                      elapsed += poll_interval
                      continue

                  stage = runtime.stage
                  print(f"[{elapsed}s] Build stage: {stage}")

                  # Check for terminal states
                  if stage == "RUNNING":
                      print("\n" + "=" * 60)
                      print("SUCCESS: Space is running!")
                      print("=" * 60)
                      sys.exit(0)
                  elif stage in ("BUILD_ERROR", "RUNTIME_ERROR", "CONFIG_ERROR"):
                      print("\n" + "=" * 60)
                      print(f"FAILURE: Space build failed with stage: {stage}")
                      if hasattr(runtime, 'error_message') and runtime.error_message:
                          print(f"Error message: {runtime.error_message}")
                      print("=" * 60)
                      sys.exit(1)
                  elif stage == "PAUSED":
                      print("\n" + "=" * 60)
                      print("WARNING: Space is paused (may need to restart)")
                      print("=" * 60)
                      sys.exit(0)
                  elif stage in ("BUILDING", "STARTING", "NO_APP_FILE"):
                      # Still in progress, continue polling
                      time.sleep(poll_interval)
                      elapsed += poll_interval
                  else:
                      # Unknown stage, wait and see
                      print(f"[{elapsed}s] Unknown stage '{stage}', continuing to poll...")
                      time.sleep(poll_interval)
                      elapsed += poll_interval

              except Exception as e:
                  print(f"[{elapsed}s] Error checking space status: {e}")
                  time.sleep(poll_interval)
                  elapsed += poll_interval

          # Timeout reached
          print("\n" + "=" * 60)
          print(f"TIMEOUT: Build did not complete within {max_wait_seconds} seconds")
          print("=" * 60)
          sys.exit(1)
          EOF
