# GitHub Actions CI definition for TensorBoard.
#
# YAML schema for GitHub Actions:
# https://help.github.com/en/actions/automating-your-workflow-with-github-actions/workflow-syntax-for-github-actions
#
# Helpful YAML parser to clarify YAML syntax:
# https://yaml-online-parser.appspot.com/

name: CI

on:
  push:
    branches:
      - master
      - '[0-9]+.*'
      - 'ci-*'
    tags:
      - '*'
  pull_request: {}
  workflow_call: {}

permissions:
  contents: read
  pull-requests: write # For PR preview deployment comments

env:
  # Keep this Bazel version in sync with the `versions.check` directive
  # in our WORKSPACE file.
  BAZEL_VERSION: '6.5.0'
  BAZEL_SHA256SUM: 'a40ac69263440761199fcb8da47ad4e3f328cbe79ffbf4ecc14e5ba252857307'
  BUILDTOOLS_VERSION: '3.0.0'
  BUILDIFIER_SHA256SUM: 'e92a6793c7134c5431c58fbc34700664f101e5c9b1c1fcd93b97978e8b7f88db'
  BUILDOZER_SHA256SUM: '3d58a0b6972e4535718cdd6c12778170ea7382de7c75bc3728f5719437ffb84d'
  TENSORFLOW_VERSION: 'tf-nightly'

defaults:
  run:
    shell: bash

jobs:
  build:
    # Use GitHub-hosted runner. The original tensorflow/tensorboard uses a
    # self-hosted runner (linux-x86-n2-32) which is not available for forks.
    runs-on: ubuntu-22.04
    needs: lint-python-flake8 # fail fast in case of "undefined variable" errors
    strategy:
      fail-fast: false
      matrix:
        tf_version_id: ['tf', 'notf']
        python_version: ['3.9']
    steps:
      - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3.3.0
      - uses: actions/setup-python@13ae5bb136fac2878aff31522b9efb785519f984 # v4.3.0
        with:
          python-version: ${{ matrix.python_version }}
          architecture: 'x64'
      - name: 'Set up Bazel'
        run: |
          ci/download_bazel.sh "${BAZEL_VERSION}" "${BAZEL_SHA256SUM}" ~/bazel
          sudo mv ~/bazel /usr/local/bin/bazel
          sudo chmod +x /usr/local/bin/bazel
          cp ./ci/bazelrc ~/.bazelrc
      - name: 'Cache Bazel'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/bazel
            ~/.cache/bazel-disk-cache
          key: bazel-${{ matrix.tf_version_id }}-${{ matrix.python_version }}-${{ hashFiles('WORKSPACE', '.bazelversion', 'third_party/**') }}
          restore-keys: |
            bazel-${{ matrix.tf_version_id }}-${{ matrix.python_version }}-
            bazel-${{ matrix.tf_version_id }}-
            bazel-
      - name: 'Install TensorFlow'
        run: |
          python -m pip install -U pip
          pip install "${TENSORFLOW_VERSION}"
        if: matrix.tf_version_id != 'notf'
      - name: 'Install Python dependencies'
        run: |
          python -m pip install -U pip
          pip install \
            -r ./tensorbored/pip_package/requirements.txt \
            -r ./tensorbored/pip_package/requirements_dev.txt \
            ;
      - name: 'Check Pip state'
        run: pip freeze --all
      - name: 'Bazel: fetch'
        run: bazel fetch //tensorbored/...
      - name: 'Bazel: build'
        # Note we suppress a flood of warnings from the proto compiler.
        # Googlers see b/222706811 & b/182876485 discussion and preconditions
        # for removing this kludge.
        run: |
          ( set -o pipefail;
            bazel build //tensorbored/... |&\
            grep -v 'external/com_google_protobuf/python: warning: directory' |&\
            grep -v 'INFO: From ProtoCompile ' )
      - name: 'Bazel: test (with TensorFlow support)'
        run: bazel test //tensorbored/...
        if: matrix.tf_version_id != 'notf'
      - name: 'Bazel: test (non-TensorFlow only)'
        run: bazel test //tensorbored/... --test_tag_filters="support_notf"
        if: matrix.tf_version_id == 'notf'
      - name: 'Bazel: run Pip package test (with TensorFlow support)'
        run: |
          bazel run //tensorbored/pip_package:test_pip_package -- \
            --tf-version "${TENSORFLOW_VERSION}"
        if: matrix.tf_version_id != 'notf'
      - name: 'Bazel: run Pip package test (non-TensorFlow only)'
        run: |
          bazel run //tensorbored/pip_package:test_pip_package -- \
            --tf-version notf
        if: matrix.tf_version_id == 'notf'
      - name: 'Bazel: run manual tests'
        run: |
          bazel test //tensorbored/compat/tensorflow_stub:gfile_s3_test &&
          bazel test //tensorbored/summary/writer:event_file_writer_s3_test &&
          bazel test //tensorbored/compat/tensorflow_stub:gfile_fsspec_test &&
          bazel test //tensorbored/summary/writer:event_file_writer_fsspec_test
      - name: 'Bazel: build Pip package (TF build only)'
        # Build wheel on pushes to master and on PRs (for preview deployments)
        if: matrix.tf_version_id == 'tf'
        run: |
          ./tensorbored/tools/set_nightly_version.sh
          rm -rf /tmp/tensorbored_pip_package && mkdir /tmp/tensorbored_pip_package
          bazel run //tensorbored/pip_package:build_pip_package -- /tmp/tensorbored_pip_package
      - name: 'Upload Pip package as an artifact (TF build only)'
        # Upload wheel artifact for master pushes and PRs.
        #
        # Note that upload-artifact GH action, starting in v4, requires the name of the uploaded
        # file(s) to be unique per workflow run, so make sure that the name is unique for each
        # "matrix" combination for which this is executed.
        if: matrix.tf_version_id == 'tf'
        uses: actions/upload-artifact@v4
        with:
          name: tensorbored-wheel_py${{ matrix.python_version }}
          path: /tmp/tensorbored_pip_package/*

  build-data-server-pip:
    runs-on: ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        mode: ['native']
        platform: ['ubuntu-22.04', 'macos-14']
        rust_version: ['1.65.0']
        include:
          - mode: 'universal'
            platform: 'ubuntu-22.04'
            rust_version: '1.65.0'
    steps:
      - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3.3.0
      - uses: actions/setup-python@13ae5bb136fac2878aff31522b9efb785519f984 # v4.3.0
        with:
          python-version: '3.9'
      - name: 'Cache Cargo artifacts'
        if: matrix.mode == 'native'
        uses: actions/cache@v4
        with:
          path: |
            tensorbored/data/server/target/
            # https://doc.rust-lang.org/cargo/guide/cargo-home.html#caching-the-cargo-home-in-ci
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            # Needed if we `cargo install` binaries (at time of writing, this
            # job doesn't but the files are tiny, and this will mitigate
            # confusion if we need to `cargo install` later)
            ~/.cargo/.crates.toml
            ~/.cargo/.crates2.json
          key: build-data-server-pip-${{ runner.os }}-cargo-${{ matrix.rust_version }}-${{ hashFiles('**/Cargo.lock', '.github/workflows/ci.yml') }}
      - name: 'Install Rust toolchain'
        if: matrix.mode == 'native'
        uses: dtolnay/rust-toolchain@5f2e2a7aff63d8cbdacb4832218a30fa7a37ee6e # current HEAD as of 1/19/2023
        with:
          toolchain: ${{ matrix.rust_version }}
          components: rustfmt
      - name: 'Install Python packaging deps'
        run: |
          python -m pip install -U pip
          pip install \
            -c ./tensorbored/pip_package/requirements.txt \
            -c ./tensorbored/pip_package/requirements_dev.txt \
            setuptools wheel
      - name: 'Build'
        if: matrix.mode == 'native'
        run: cd tensorbored/data/server/ && cargo build --release
      - name: 'Test'
        if: matrix.mode == 'native'
        run: cd tensorbored/data/server/ && cargo test --release
      - name: 'Package (native)'
        if: matrix.mode == 'native'
        run: |
          rm -rf /tmp/pip_package && mkdir /tmp/pip_package
          python tensorbored/data/server/pip_package/build.py \
            --server-binary tensorbored/data/server/target/release/rustboard \
            --out-dir /tmp/pip_package \
            ;
      - name: 'Package (universal)'
        if: matrix.mode == 'universal'
        run: |
          rm -rf /tmp/pip_package && mkdir /tmp/pip_package
          python tensorbored/data/server/pip_package/build.py \
            --universal \
            --out-dir /tmp/pip_package \
            ;
      - name: 'Upload'
        uses: actions/upload-artifact@v4
        with:
          name: tensorboard-data-server_${{ matrix.mode }}_${{ matrix.platform }}_${{ matrix.rust_version }}
          path: /tmp/pip_package/*

  lint-python-flake8:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        # flake8 should run on each Python version that we target,
        # because the errors and warnings can differ due to language
        # changes, and we want to catch them all.
        python_version: ['3.9', '3.10', '3.11']
    steps:
      - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3.3.0
      - uses: actions/setup-python@13ae5bb136fac2878aff31522b9efb785519f984 # v4.3.0
        with:
          python-version: ${{ matrix.python_version }}
          architecture: 'x64'
      - name: 'Install flake8'
        run: |
          python -m pip install -U pip
          pip install flake8 -c ./tensorbored/pip_package/requirements_dev.txt
      - run: pip freeze --all
      - name: 'Lint Python code for errors with flake8'
        # See: http://flake8.pycqa.org/en/3.7.8/user/error-codes.html
        # Use the comment '# noqa: <error code>' to suppress.
        run: flake8 . --count --select=E9,F63,F7,F82,F401 --show-source --statistics

  lint-python-yaml-docs:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3.3.0
      - uses: actions/setup-python@13ae5bb136fac2878aff31522b9efb785519f984 # v4.3.0
        with:
          python-version: '3.10'
          architecture: 'x64'
      - name: 'Install black, yamllint, and the TensorFlow docs notebook tools'
        run: |
          python -m pip install -U pip
          nbfmt_version="84bd7bea0c468667dd0ec273d426ed50f23e1a15"
          pip install black yamllint -c ./tensorbored/pip_package/requirements_dev.txt
          pip install -U git+https://github.com/tensorflow/docs@${nbfmt_version}
        # Workaround tensorflow incompatibility with protobuf>4.
        # See: https://github.com/tensorflow/tensorbored/issues/5708.
        # See: https://github.com/tensorflow/tensorflow/issues/53234.
      - name: 'Downgrade to compatible protobuf version'
        run: pip install -U "protobuf<3.20"
      - run: pip freeze --all
      - name: 'Lint Python code for style with Black'
        # You can run `black .` to fix all Black complaints.
        run: black --check --diff .
      - name: 'Lint YAML for gotchas with yamllint'
        # Use '# yamllint disable-line rule:foo' to suppress.
        run: yamllint -c docs/.yamllint docs docs/.yamllint
      - name: 'Lint Colab notebooks for formatting with nbfmt'
        run: git ls-files -z '*.ipynb' | xargs -0 python3 -m tensorflow_docs.tools.nbfmt --test

  lint-rust:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        rust_version: ['1.65.0']
        cargo_raze_version: ['0.16.1']
    steps:
      - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3.3.0
      - name: 'Cache Cargo artifacts'
        uses: actions/cache@v4
        with:
          path: |
            tensorbored/data/server/target/
            # https://doc.rust-lang.org/cargo/guide/cargo-home.html#caching-the-cargo-home-in-ci
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            # Needed for installing binaries (`cargo-raze`) with cache
            ~/.cargo/.crates.toml
            ~/.cargo/.crates2.json
          key: lint-rust-${{ runner.os }}-cargo-${{ matrix.rust_version }}-${{ matrix.cargo_raze_version }}-${{ hashFiles('**/Cargo.lock', '.github/workflows/ci.yml') }}
      - name: 'Install Rust toolchain'
        uses: dtolnay/rust-toolchain@5f2e2a7aff63d8cbdacb4832218a30fa7a37ee6e # current HEAD as of 1/19/2023
        with:
          toolchain: ${{ matrix.rust_version }}
          components: rustfmt, clippy
      - name: 'Install cargo-raze'
        run: cargo install cargo-raze --version ${{ matrix.cargo_raze_version }} --locked
      - name: 'Run Rustfmt'
        run: (cd tensorbored/data/server/ && cargo fmt -- --check)
      - name: 'Run Clippy'
        # You can run `cargo clippy --all-targets --manifest-path tensorbored/data/server/Cargo.toml --fix` to fix all Clippy complaints.
        # This will only apply `MachineApplicable` fixes (https://doc.rust-lang.org/nightly/nightly-rustc/rustc_lint_defs/enum.Applicability.html), so some modifications may need to be done manually.
        run: cargo clippy --all-targets --manifest-path tensorbored/data/server/Cargo.toml -- -D warnings
      - name: 'Check cargo-raze freshness'
        run: |
          rm -rf third_party/rust/
          (cd tensorbored/data/server/ && cargo fetch && cargo raze)
          git add .
          git diff --staged --exit-code

  lint-frontend:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3.3.0
      - uses: actions/setup-node@64ed1c7eab4cce3362f8c340dee64e5eaeef8f7c # v3.6.0
        with:
          node-version: 16
      - run: yarn install --ignore-engines
        # You can run `yarn fix-lint` to fix all Prettier complaints, although at this point this will try to fix too many things.
        # To fix only the files changed in this PR, see the command below.
      - run: yarn lint || (( echo 'Try running `$ prettier --write $(git diff-tree --no-commit-id --name-only <latest commit> <parent branch commit> -r)`.' && false ))
        # Make sure no tests are skipped with "focused" tests.
      - run: |
          ! git grep -E 'f(it|describe)\(' 'tensorbored/*_test.ts'
        # Make sure no one depends on Angular material and CDK directly. Please
        # import the indirection in //tensorbored/webapp/angular.
      - run: |
          ! git grep -E '"@npm//@angular/material"|"@npm//@angular/cdk"' 'tensorbored/*/BUILD' ':!tensorbored/webapp/BUILD' ':!tensorbored/webapp/angular/BUILD'
        # Cannot directly depend on d3 in webapp. Must depend on
        # `//tensorbored/webapp/third_party:d3` instead.
      - run: |
          ! git grep -E '"@npm//d3"|"@npm//@types/d3"' 'tensorbored/webapp/**/*BUILD' ':!tensorbored/webapp/third_party/**'
      - run: |
          ! git grep -E '"@npm_angular_bazel//:index.bzl"' 'tensorbored/**/BUILD'
      - run: |
          ! git grep -E 'mat-color|$mat-' 'tensorbored/**/*.scss'
        # Make sure no one depends on  the numeric library directly. Please
        # import the indirection in //tensorbored/webapp/third_party.
      - run: |
          ! git grep -E '@npm//numeric' 'tensorbored/*/BUILD' ':!tensorbored/webapp/third_party/**'

  lint-misc: # build, protos, etc.
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3.3.0
      - name: 'Set up Buildifier'
        run: |
          ci/download_buildifier.sh "${BUILDTOOLS_VERSION}" "${BUILDIFIER_SHA256SUM}" ~/buildifier
          sudo mv ~/buildifier /usr/local/bin/buildifier
      - name: 'Set up Buildozer'
        run: |
          ci/download_buildozer.sh "${BUILDTOOLS_VERSION}" "${BUILDOZER_SHA256SUM}" ~/buildozer
          sudo mv ~/buildozer /usr/local/bin/buildozer
      - name: 'Lint BUILD files'
        # TODO(tensorboard-team): address all lint warnings and remove the exemption.
        run:
          git ls-files -z '*BUILD' third_party/js.bzl third_party/workspace.bzl WORKSPACE | xargs -0 buildifier --mode=check --lint=warn
          --warnings=-native-py,-native-java
      - run: ./tensorbored/tools/mirror_urls_test.sh
      - name: 'Lint for no py2 BUILD targets'
        # Use | to start a literal so YAML doesn't complain about the '!' character.
        run: |
          ! git grep 'python_version = "PY2"' '*BUILD'
      - name: 'No comments on licenses rule'
        # Assert buildozer error code for 'success, when no changes were made'.
        # https://github.com/bazelbuild/buildtools/blob/master/buildozer/README.md#error-code
        run: |
          buildozer '//tensorbored/...:%licenses' remove_comment && false || test $? = 3
      - name: clang-format lint
        uses: DoozyX/clang-format-lint-action@0138140a2adaafd3032a3ff37f66366fd7dc88e0
        with:
          source: ./tensorbored
          # Exclude tensorbored/compat because the source of truth is TensorFlow.
          exclude: ./tensorbored/compat/proto
          extensions: 'proto'
          clangFormatVersion: 9
      - run: ./tensorbored/tools/do_not_submit_test.sh
      - run: ./tensorbored/tools/license_test.sh
      - run: ./tensorbored/tools/whitespace_hygiene_test.py

  deploy-pr-preview:
    runs-on: ubuntu-22.04
    needs: build
    # Only deploy previews for PRs, not pushes to master
    if: github.event_name == 'pull_request'
    env:
      SPACE_PREFIX: tensorbored-pr
      HF_USERNAME: Demonstrandum
    steps:
      - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3.3.0

      - name: Download wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: tensorbored-wheel_py3.9
          path: wheel

      - name: Get wheel filename
        id: wheel
        run: |
          WHEEL_FILE=$(ls wheel/*.whl | head -1)
          WHEEL_NAME=$(basename "$WHEEL_FILE")
          echo "filename=${WHEEL_NAME}" >> $GITHUB_OUTPUT
          echo "Found wheel: ${WHEEL_NAME}"

      - uses: actions/setup-python@13ae5bb136fac2878aff31522b9efb785519f984 # v4.3.0
        with:
          python-version: '3.11'

      - name: Install huggingface_hub
        run: pip install huggingface_hub

      - name: Prepare Space files
        id: deploy
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          SPACE_NAME="${SPACE_PREFIX}-${PR_NUMBER}"
          SPACE_REPO="${HF_USERNAME}/${SPACE_NAME}"
          SPACE_URL="https://huggingface.co/spaces/${SPACE_REPO}"
          EMBED_URL="https://${HF_USERNAME}-${SPACE_NAME}.hf.space"
          SHORT_SHA="${GITHUB_SHA:0:7}"
          WHEEL_NAME="${{ steps.wheel.outputs.filename }}"

          echo "space_name=${SPACE_NAME}" >> $GITHUB_OUTPUT
          echo "space_repo=${SPACE_REPO}" >> $GITHUB_OUTPUT
          echo "space_url=${SPACE_URL}" >> $GITHUB_OUTPUT
          echo "embed_url=${EMBED_URL}" >> $GITHUB_OUTPUT

          mkdir -p hf-space

          # Copy wheel and demo files
          cp wheel/*.whl hf-space/
          cp demo/Dockerfile hf-space/
          cp demo/generate_demo_data.py hf-space/
          cp demo/start.sh hf-space/

          # Create cache-busting file to force Docker layer invalidation.
          # Without this, HuggingFace Spaces may use cached pip install with old wheel.
          echo "wheel=${WHEEL_NAME}" > hf-space/.build-version
          echo "commit=${SHORT_SHA}" >> hf-space/.build-version
          echo "timestamp=$(date -u +%Y%m%d%H%M%S)" >> hf-space/.build-version
          cat hf-space/.build-version

          # Generate PR-specific README (needs PR number in frontmatter)
          cat > hf-space/README.md << EOF
          ---
          title: TensorBored PR #${PR_NUMBER} Preview
          emoji: "\U0001F50D"
          colorFrom: yellow
          colorTo: purple
          sdk: docker
          pinned: false
          license: apache-2.0
          ---

          # TensorBored PR #${PR_NUMBER} Preview

          Preview for [PR #${PR_NUMBER}](https://github.com/${{ github.repository }}/pull/${PR_NUMBER}).

          **Wheel**: \`${WHEEL_NAME}\`
          **Commit**: [${SHORT_SHA}](https://github.com/${{ github.repository }}/commit/${GITHUB_SHA})

          ---

          EOF
          sed -i 's/^          //' hf-space/README.md
          tail -n +10 demo/README.md >> hf-space/README.md

      - name: Upload to HuggingFace Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          SPACE_REPO="${{ steps.deploy.outputs.space_repo }}"
          PR_NUMBER=${{ github.event.pull_request.number }}
          SHORT_SHA="${GITHUB_SHA:0:7}"

          python3 << PYPYTHON
          from huggingface_hub import HfApi, create_repo, list_repo_files
          from huggingface_hub.utils import RepositoryNotFoundError

          api = HfApi()
          repo_id = "${SPACE_REPO}"

          try:
              api.repo_info(repo_id=repo_id, repo_type="space")
              print(f"Space {repo_id} exists")

              # Delete old wheel files to avoid pip install conflicts
              # (Dockerfile uses *.whl which would match multiple versions)
              existing_files = list_repo_files(repo_id=repo_id, repo_type="space")
              old_wheels = [f for f in existing_files if f.endswith('.whl')]
              if old_wheels:
                  print(f"Deleting {len(old_wheels)} old wheel file(s): {old_wheels}")
                  for wheel_file in old_wheels:
                      api.delete_file(path_in_repo=wheel_file, repo_id=repo_id, repo_type="space")
          except RepositoryNotFoundError:
              print(f"Creating space {repo_id}")
              create_repo(repo_id=repo_id, repo_type="space", space_sdk="docker", private=False)

          print(f"Uploading to {repo_id}")
          api.upload_folder(
              folder_path="hf-space",
              repo_id=repo_id,
              repo_type="space",
              commit_message="PR #${PR_NUMBER}: ${SHORT_SHA}",
          )
          print("Done!")
          PYPYTHON

      - name: Wait for HuggingFace Space build
        id: hf-build
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          SPACE_REPO: ${{ steps.deploy.outputs.space_repo }}
        run: |
          python3 << 'PYPYTHON'
          import os
          import sys
          import time
          from huggingface_hub import HfApi

          api = HfApi()
          repo_id = os.environ.get("SPACE_REPO")

          print(f"Waiting for Space build to complete: {repo_id}")
          print("=" * 60)

          # Poll for build status with timeout
          max_wait_seconds = 600  # 10 minutes
          poll_interval = 15  # seconds
          elapsed = 0
          final_status = "unknown"

          while elapsed < max_wait_seconds:
              try:
                  space_info = api.space_info(repo_id=repo_id)
                  runtime = space_info.runtime

                  if runtime is None:
                      print(f"[{elapsed}s] Space runtime info not available yet...")
                      time.sleep(poll_interval)
                      elapsed += poll_interval
                      continue

                  stage = runtime.stage
                  print(f"[{elapsed}s] Build stage: {stage}")

                  # Check for terminal states
                  if stage == "RUNNING":
                      print("\n" + "=" * 60)
                      print("SUCCESS: Space is running!")
                      print("=" * 60)
                      final_status = "success"
                      break
                  elif stage in ("BUILD_ERROR", "RUNTIME_ERROR", "CONFIG_ERROR"):
                      print("\n" + "=" * 60)
                      print(f"FAILURE: Space build failed with stage: {stage}")
                      if hasattr(runtime, 'error_message') and runtime.error_message:
                          print(f"Error message: {runtime.error_message}")
                      print("=" * 60)
                      final_status = "failure"
                      break
                  elif stage == "PAUSED":
                      print("\n" + "=" * 60)
                      print("WARNING: Space is paused (may need to restart)")
                      print("=" * 60)
                      final_status = "success"
                      break
                  elif stage in ("BUILDING", "STARTING", "NO_APP_FILE"):
                      # Still in progress, continue polling
                      time.sleep(poll_interval)
                      elapsed += poll_interval
                  else:
                      # Unknown stage, wait and see
                      print(f"[{elapsed}s] Unknown stage '{stage}', continuing to poll...")
                      time.sleep(poll_interval)
                      elapsed += poll_interval

              except Exception as e:
                  print(f"[{elapsed}s] Error checking space status: {e}")
                  time.sleep(poll_interval)
                  elapsed += poll_interval

          if final_status == "unknown":
              print("\n" + "=" * 60)
              print(f"TIMEOUT: Build did not complete within {max_wait_seconds} seconds")
              print("=" * 60)
              final_status = "timeout"

          # Write status to output file for GitHub Actions
          with open(os.environ.get("GITHUB_OUTPUT", "/dev/null"), "a") as f:
              f.write(f"status={final_status}\n")

          # Exit with error for failures (but not timeouts - we'll report those in the comment)
          if final_status == "failure":
              sys.exit(1)
          PYPYTHON

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        # Always run so we can update the comment even on failure
        if: always()
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '<!-- pr-preview-comment -->'

      - name: Post PR comment
        uses: peter-evans/create-or-update-comment@v4
        # Always run so we can update the comment even on failure
        if: always()
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            <!-- pr-preview-comment -->
            ## Preview Deployment

            | | |
            |-|-|
            | **Status** | ${{ steps.hf-build.outputs.status == 'success' && '‚úÖ Running' || steps.hf-build.outputs.status == 'failure' && '‚ùå Build Failed' || steps.hf-build.outputs.status == 'timeout' && '‚è≥ Build Timeout' || 'üîÑ Building...' }} |
            | **Live Preview** | [${{ steps.deploy.outputs.embed_url }}](${{ steps.deploy.outputs.embed_url }}) |
            | **Space** | [${{ steps.deploy.outputs.space_url }}](${{ steps.deploy.outputs.space_url }}) |

            ${{ steps.hf-build.outputs.status == 'failure' && '‚ö†Ô∏è **The HuggingFace Space build failed.** Check the [Space logs](' || '' }}${{ steps.hf-build.outputs.status == 'failure' && steps.deploy.outputs.space_url || '' }}${{ steps.hf-build.outputs.status == 'failure' && ') for details.' || '' }}

            <details>
            <summary>Details</summary>

            - Wheel: `${{ steps.wheel.outputs.filename }}`
            - Commit: ${{ github.sha }}
            - Build status: ${{ steps.hf-build.outputs.status }}
            </details>
