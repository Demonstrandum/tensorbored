# GitHub Actions workflow to publish wheels as prerelease on push to master.
#
# This workflow builds the pip package and publishes it as a GitHub prerelease,
# making it easy to download and test the latest changes without waiting for
# an official release. It also publishes RC versions to PyPI using OIDC
# (Trusted Publishers) - no API tokens required.

name: Wheel Prerelease

on:
  push:
    branches:
      - master

permissions:
  contents: write # Needed for creating releases
  id-token: write # Needed for PyPI OIDC trusted publishing
  pull-requests: write # Needed by ci.yml for PR preview comments
  actions: read # Needed by deploy-demo.yml for artifact downloads

env:
  BAZEL_VERSION: '6.5.0'
  BAZEL_SHA256SUM: 'a40ac69263440761199fcb8da47ad4e3f328cbe79ffbf4ecc14e5ba252857307'

jobs:
  ci:
    uses: ./.github/workflows/ci.yml

  build-rc-wheel:
    runs-on: ubuntu-22.04
    needs: ci
    steps:
      - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3.3.0

      - uses: actions/setup-python@13ae5bb136fac2878aff31522b9efb785519f984 # v4.3.0
        with:
          python-version: '3.9'
          architecture: 'x64'

      - name: 'Set up Bazel'
        run: |
          ci/download_bazel.sh "${BAZEL_VERSION}" "${BAZEL_SHA256SUM}" ~/bazel
          sudo mv ~/bazel /usr/local/bin/bazel
          sudo chmod +x /usr/local/bin/bazel
          cp ./ci/bazelrc ~/.bazelrc

      - name: 'Cache Bazel'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/bazel
            ~/.cache/bazel-disk-cache
          key: bazel-rc-wheel-3.9-${{ hashFiles('WORKSPACE', '.bazelversion', 'third_party/**') }}
          restore-keys: |
            bazel-rc-wheel-3.9-
            bazel-tf-3.9-
            bazel-tf-
            bazel-

      - name: 'Install Python dependencies'
        run: |
          python -m pip install -U pip
          pip install \
            -r ./tensorbored/pip_package/requirements.txt \
            -r ./tensorbored/pip_package/requirements_dev.txt \
            ;

      - name: 'Bazel: fetch and build'
        run: |
          bazel fetch //tensorbored/...
          bazel build //tensorbored/... 2>&1 | grep -v 'external/com_google_protobuf/python: warning: directory' | grep -v 'INFO: From ProtoCompile ' || true

      - name: 'Set RC version'
        run: ./tensorbored/tools/set_rc_version.sh

      - name: 'Build RC pip package'
        run: |
          rm -rf /tmp/tensorbored_rc_pip_package && mkdir /tmp/tensorbored_rc_pip_package
          bazel run //tensorbored/pip_package:build_pip_package -- /tmp/tensorbored_rc_pip_package

      - name: 'Upload RC wheel artifact'
        uses: actions/upload-artifact@v4
        with:
          name: tensorbored-rc-wheel
          path: /tmp/tensorbored_rc_pip_package/*

  publish-prerelease:
    runs-on: ubuntu-22.04
    needs: build-rc-wheel
    steps:
      - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3.3.0

      - name: Download RC pip package artifacts
        uses: actions/download-artifact@v4
        with:
          name: tensorbored-rc-wheel
          path: wheels

      - name: Get version info
        id: version
        run: |
          # Extract version from the wheel filename
          WHEEL_FILE=$(ls wheels/*.whl | head -1)
          WHEEL_NAME=$(basename "$WHEEL_FILE")
          echo "wheel_name=$WHEEL_NAME" >> "$GITHUB_OUTPUT"

          # Extract version from wheel name (format: tensorbored-X.Y.ZrcYYYYMMDD-py3-none-any.whl)
          VERSION=$(echo "$WHEEL_NAME" | sed -E 's/tensorbored-([^-]+)-.*/\1/')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          # Create a unique tag based on date and short SHA
          SHORT_SHA="${GITHUB_SHA:0:7}"
          DATE=$(date -u +%Y%m%d)
          TAG="prerelease-${DATE}-${SHORT_SHA}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "date=$DATE" >> "$GITHUB_OUTPUT"
          echo "short_sha=$SHORT_SHA" >> "$GITHUB_OUTPUT"

      - name: List wheel files
        run: ls -la wheels/

      - name: Create GitHub Prerelease
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: 'Prerelease ${{ steps.version.outputs.date }} (${{ steps.version.outputs.short_sha }})'
          body: |
            ## Automated Prerelease Build

            This is an automated prerelease build from commit ${{ github.sha }}.

            **Version:** `${{ steps.version.outputs.version }}`
            **Commit:** [`${{ steps.version.outputs.short_sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
            **Branch:** `master`
            **Date:** ${{ steps.version.outputs.date }}

            ### Installation

            Install from PyPI (recommended):
            ```bash
            pip install tensorbored==${{ steps.version.outputs.version }}
            ```

            Or download the wheel file and install with:
            ```bash
            pip install ${{ steps.version.outputs.wheel_name }}
            ```

            Or install directly from this release:
            ```bash
            pip install ${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/${{ steps.version.outputs.wheel_name }}
            ```

            ### Warning

            This is a prerelease build intended for testing. It may contain bugs or incomplete features.
          draft: false
          prerelease: true
          files: wheels/*.whl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish RC to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: wheels/
          print-hash: true

  deploy-demo:
    needs: publish-prerelease
    uses: ./.github/workflows/deploy-demo.yml
    secrets:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
