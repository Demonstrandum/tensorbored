name: PR Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

# Cancel in-progress runs for the same PR
concurrency:
  group: pr-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  # Base name for preview spaces
  SPACE_PREFIX: tensorbored-pr
  # HuggingFace username/org where spaces will be created
  HF_USERNAME: Demonstrandum

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    permissions:
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install huggingface_hub
        run: pip install huggingface_hub

      - name: Setup Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Create or update HuggingFace Space
        id: deploy
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          SPACE_NAME="${SPACE_PREFIX}-${PR_NUMBER}"
          SPACE_REPO="${HF_USERNAME}/${SPACE_NAME}"
          SPACE_URL="https://huggingface.co/spaces/${SPACE_REPO}"
          EMBED_URL="https://${HF_USERNAME}-${SPACE_NAME}.hf.space"

          echo "space_name=${SPACE_NAME}" >> $GITHUB_OUTPUT
          echo "space_url=${SPACE_URL}" >> $GITHUB_OUTPUT
          echo "embed_url=${EMBED_URL}" >> $GITHUB_OUTPUT

          # Create space if it doesn't exist (will be a no-op if it exists)
          python - <<EOF
          from huggingface_hub import HfApi, create_repo
          from huggingface_hub.utils import RepositoryNotFoundError

          api = HfApi()
          repo_id = "${SPACE_REPO}"

          try:
              api.repo_info(repo_id=repo_id, repo_type="space")
              print(f"Space {repo_id} already exists")
          except RepositoryNotFoundError:
              print(f"Creating space {repo_id}")
              create_repo(
                  repo_id=repo_id,
                  repo_type="space",
                  space_sdk="docker",
                  private=False,
              )
              print(f"Created space {repo_id}")
          EOF

          # Clone the space
          git clone "https://user:${HF_TOKEN}@huggingface.co/spaces/${SPACE_REPO}" hf-space || {
            # If clone fails, initialize a new repo
            mkdir -p hf-space
            cd hf-space
            git init
            git remote add origin "https://user:${HF_TOKEN}@huggingface.co/spaces/${SPACE_REPO}"
            cd ..
          }

          # Prepare the README with PR-specific metadata
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_BRANCH="${{ github.head_ref }}"
          REPO="${{ github.repository }}"

          cat > hf-space/README.md << EOF
---
title: TensorBored PR #${PR_NUMBER} Preview
emoji: ðŸ”
colorFrom: orange
colorTo: yellow
sdk: docker
pinned: false
license: apache-2.0
---

# TensorBored PR #${PR_NUMBER} Preview

This is a **preview deployment** for [PR #${PR_NUMBER}](https://github.com/${REPO}/pull/${PR_NUMBER}).

> **Note**: This space will be automatically deleted when the PR is closed or merged.

## PR Details

- **Title**: ${PR_TITLE}
- **Branch**: \`${PR_BRANCH}\`
- **Author**: @${PR_AUTHOR}

---

EOF

          # Append the rest of the demo README (skipping the frontmatter)
          tail -n +10 demo/README.md >> hf-space/README.md

          # Copy demo files
          cp demo/Dockerfile hf-space/
          cp demo/generate_demo_data.py hf-space/
          cp demo/start.sh hf-space/

          # Copy TensorBored custom modules
          mkdir -p hf-space/tensorbored_plugins_core
          cp tensorbored/plugins/core/profile_writer.py \
            hf-space/tensorbored_plugins_core/
          cp tensorbored/plugins/core/color_sampler.py \
            hf-space/tensorbored_plugins_core/
          cp tensorbored/plugins/core/__init__.py \
            hf-space/tensorbored_plugins_core/

          # Commit and push
          cd hf-space
          git add -A

          if git diff --staged --quiet; then
            echo "No changes to deploy"
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "PR #${PR_NUMBER}: ${{ github.event.pull_request.title }}"
            git push --set-upstream origin main || git push --set-upstream origin master
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Deployed successfully!"
          fi

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '<!-- pr-preview-comment -->'

      - name: Create or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            <!-- pr-preview-comment -->
            ## ðŸ” Preview Deployment

            Your PR preview is being deployed to HuggingFace Spaces!

            | Resource | Link |
            |----------|------|
            | **Live Preview** | [${{ steps.deploy.outputs.embed_url }}](${{ steps.deploy.outputs.embed_url }}) |
            | **Space Settings** | [${{ steps.deploy.outputs.space_url }}](${{ steps.deploy.outputs.space_url }}) |

            > **Note**: The space may take 1-3 minutes to build after deployment. If you see a "Building" status, please wait and refresh.

            <details>
            <summary>ðŸ“‹ Deployment Details</summary>

            - **Space Name**: `${{ steps.deploy.outputs.space_name }}`
            - **Commit**: ${{ github.sha }}
            - **Deployed at**: ${{ github.event.pull_request.updated_at }}

            This preview will be automatically deleted when the PR is closed or merged.
            </details>

  cleanup-preview:
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install huggingface_hub
        run: pip install huggingface_hub

      - name: Delete HuggingFace Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          SPACE_NAME="${SPACE_PREFIX}-${PR_NUMBER}"
          SPACE_REPO="${HF_USERNAME}/${SPACE_NAME}"

          python - <<EOF
          from huggingface_hub import HfApi, delete_repo
          from huggingface_hub.utils import RepositoryNotFoundError

          api = HfApi()
          repo_id = "${SPACE_REPO}"

          try:
              api.repo_info(repo_id=repo_id, repo_type="space")
              print(f"Deleting space {repo_id}")
              delete_repo(repo_id=repo_id, repo_type="space")
              print(f"Deleted space {repo_id}")
          except RepositoryNotFoundError:
              print(f"Space {repo_id} not found, nothing to delete")
          EOF

          echo "Cleanup complete for PR #${PR_NUMBER}"
